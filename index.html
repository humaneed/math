<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#4A7C91">
  <title>Mathe √ºben ‚Äì Kidsneed</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    /* ============================================
       KIDSNEED DESIGN SYSTEM
       ============================================ */
    
    :root {
      /* Spacing (8px Grid) */
      --s-1: 8px;
      --s-2: 16px;
      --s-3: 24px;
      --s-4: 32px;
      --s-5: 48px;

      /* Radii */
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-xl: 28px;

      /* Shadows */
      --shadow-soft: 0 2px 10px rgba(45,42,38,.10);
      --shadow-subtle: 0 1px 3px rgba(45,42,38,.06);

      /* Colors ‚Äì Kidsneed Palette */
      --bg-canvas: #F5F0E8;
      --bg-card: #FFFFFF;
      --bg-muted: #EDE8DC;

      --ink-primary: #2D2A26;
      --ink-secondary: #6B665C;
      --ink-light: #9C9588;

      /* Modul-Akzent: Mathe = Blau-Gr√ºn */
      --accent: #4A7C91;
      --accent-light: rgba(74,124,145,.12);
      --accent-dark: #3A6275;

      /* Feedback */
      --color-success: #7BA08A;
      --color-success-bg: rgba(123,160,138,.15);
      --color-error: #C4726C;
      --color-error-bg: rgba(196,114,108,.15);
      --color-warn: #D4A574;
      --color-warn-bg: rgba(212,165,116,.15);

      /* Typography */
      --text-2xl: 24px;
      --text-xl: 20px;
      --text-lg: 18px;
      --text-md: 16px;
      --text-sm: 14px;
      --text-xs: 12px;

      /* Motion */
      --motion-fast: 150ms;
      --motion-base: 260ms;
      --ease-out: cubic-bezier(0.33, 1, 0.68, 1);

      /* Layout */
      --app-max-w: 560px;
      --font: 'Nunito', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    *, *::before, *::after { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
    }
    
    html, body { height: 100%; }
    
    body {
      margin: 0;
      background: var(--bg-canvas);
      color: var(--ink-primary);
      font-family: var(--font);
      font-weight: 600;
      font-size: var(--text-md);
      line-height: 1.5;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    *:focus-visible {
      outline: 3px solid var(--accent);
      outline-offset: 2px;
      border-radius: var(--radius-sm);
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
      }
    }

    /* === APP FRAME === */
    .app-frame {
      width: 100%;
      height: 100%;
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    @media (min-width: 520px) {
      body { padding: var(--s-3); }
      .app-frame {
        max-width: var(--app-max-w);
        height: 94dvh;
        max-height: 920px;
        border: 3px solid var(--ink-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-subtle);
      }
    }

    /* === HEADER === */
    header {
      height: 72px;
      padding: 0 var(--s-3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--s-2);
      border-bottom: 3px solid var(--ink-primary);
      background: var(--bg-card);
      flex: 0 0 auto;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .brand-title {
      font-size: var(--text-xl);
      font-weight: 900;
      letter-spacing: -0.02em;
      line-height: 1.1;
      display: flex;
      align-items: center;
      gap: var(--s-1);
    }

    .brand-subtitle {
      font-size: var(--text-xs);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: var(--ink-secondary);
    }

    .header-stats {
      display: flex;
      gap: var(--s-1);
      align-items: center;
    }

    /* === PILL (Stats) === */
    .pill {
      min-height: 48px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--ink-primary);
      background: var(--bg-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      cursor: pointer;
      transition: transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out);
    }

    .pill:hover {
      box-shadow: var(--shadow-soft);
      transform: translateY(-1px);
    }

    .pill:active {
      transform: scale(0.98);
      box-shadow: none;
    }

    .pill .icon { font-size: 16px; }
    .pill .val { 
      font-weight: 900; 
      font-size: var(--text-sm);
      font-variant-numeric: tabular-nums;
    }

    /* === VIEWPORT (Main Content) === */
    .viewport {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: var(--s-3);
      background:
        radial-gradient(1200px 340px at 50% 0%, rgba(74,124,145,.08), transparent 60%),
        var(--bg-card);
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    /* === CARD === */
    .card {
      border: 3px solid var(--ink-primary);
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      box-shadow: var(--shadow-subtle);
      margin-bottom: var(--s-3);
    }

    .card-section {
      padding: var(--s-3);
    }

    .card-section + .card-section {
      border-top: 3px solid var(--ink-primary);
    }

    /* === SECTION TITLE === */
    .section-label {
      font-size: var(--text-xs);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: var(--ink-secondary);
      margin-bottom: var(--s-2);
    }

    /* === GRADE SELECTOR === */
    .grade-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--s-1);
    }

    .grade-btn {
      min-height: 52px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--ink-primary);
      background: var(--bg-muted);
      font-family: var(--font);
      font-weight: 900;
      font-size: var(--text-lg);
      color: var(--ink-primary);
      cursor: pointer;
      transition: transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out);
    }

    .grade-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .grade-btn:active {
      transform: scale(0.98);
      box-shadow: none;
    }

    .grade-btn.selected {
      background: var(--accent);
      color: white;
      border-color: var(--accent-dark);
    }

    /* === ICON BUTTONS ROW === */
    .icon-row {
      display: flex;
      gap: var(--s-1);
      margin-top: var(--s-2);
      justify-content: flex-end;
    }

    .icon-btn {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--ink-primary);
      background: var(--bg-muted);
      cursor: pointer;
      font-size: 20px;
      color: var(--ink-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out);
    }

    .icon-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .icon-btn:active {
      transform: scale(0.98);
      box-shadow: none;
    }

    /* === TASK AREA === */
    .task-container {
      position: relative;
    }

    .timer {
      position: absolute;
      top: var(--s-1);
      right: var(--s-1);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--accent);
      background: var(--bg-card);
      font-weight: 900;
      font-size: var(--text-sm);
      color: var(--accent);
      display: none;
      align-items: center;
      gap: 4px;
    }

    .timer.active {
      display: flex;
    }

    .timer.warning {
      background: var(--color-error-bg);
      border-color: var(--color-error);
      color: var(--color-error);
    }

    .task-area {
      background: var(--bg-muted);
      border: 3px solid var(--ink-primary);
      border-radius: var(--radius-md);
      padding: var(--s-4) var(--s-3);
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .task-text {
      font-size: clamp(1.75rem, 8vw, 2.5rem);
      font-weight: 900;
      color: var(--ink-primary);
      text-align: center;
      line-height: 1.3;
      letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
    }

    .task-text.word-problem {
      font-size: clamp(1rem, 4vw, 1.25rem);
      font-weight: 800;
      line-height: 1.5;
    }

    /* === ANSWER GRID === */
    .answers {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--s-2);
      margin-top: var(--s-3);
    }

    .answer-btn {
      padding: var(--s-3);
      border: 3px solid var(--ink-primary);
      border-radius: var(--radius-md);
      background: var(--bg-card);
      font-family: var(--font);
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--ink-primary);
      cursor: pointer;
      transition: transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out);
      min-height: 64px;
    }

    .answer-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
      background: var(--accent-light);
    }

    .answer-btn:active {
      transform: scale(0.98);
      box-shadow: none;
    }

    .answer-btn.correct {
      background: var(--color-success);
      border-color: var(--color-success);
      color: white;
    }

    .answer-btn.incorrect {
      background: var(--color-error);
      border-color: var(--color-error);
      color: white;
    }

    /* === FEEDBACK === */
    .feedback {
      margin-top: var(--s-3);
      padding: var(--s-2);
      border-radius: var(--radius-sm);
      border: 2px solid var(--ink-primary);
      background: var(--bg-muted);
      font-weight: 900;
      font-size: var(--text-sm);
      color: var(--ink-secondary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .feedback .ficon {
      font-size: 18px;
      line-height: 1;
    }

    .feedback.success {
      background: var(--color-success-bg);
      border-color: var(--color-success);
      color: #2D5A3A;
    }

    .feedback.error {
      background: var(--color-error-bg);
      border-color: var(--color-error);
      color: #6B3A32;
    }

    /* === HISTORY DOTS === */
    .history-dots {
      display: flex;
      gap: 6px;
      margin-top: var(--s-2);
      justify-content: center;
      flex-wrap: wrap;
    }

    .dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid var(--ink-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 900;
    }

    .dot.correct {
      background: var(--color-success-bg);
      border-color: var(--color-success);
      color: var(--color-success);
    }

    .dot.incorrect {
      background: var(--color-error-bg);
      border-color: var(--color-error);
      color: var(--color-error);
    }

    /* === BUTTONS === */
    .btn {
      min-height: 52px;
      padding: 14px 18px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--ink-primary);
      background: var(--bg-card);
      color: var(--ink-secondary);
      font-family: var(--font);
      font-weight: 900;
      font-size: var(--text-md);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out), filter var(--motion-fast) var(--ease-out);
      user-select: none;
      text-decoration: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent-dark);
    }

    .btn.primary:hover {
      filter: brightness(1.05);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .actions {
      display: flex;
      gap: var(--s-2);
      margin-top: var(--s-3);
    }

    .actions .btn {
      flex: 1;
    }

    /* === FOOTER === */
    footer {
      flex: 0 0 auto;
      padding: var(--s-2) var(--s-3);
      padding-bottom: max(var(--s-2), env(safe-area-inset-bottom));
      background: var(--bg-card);
      border-top: 3px solid var(--ink-primary);
      display: flex;
      gap: var(--s-2);
    }

    footer .btn {
      flex: 1;
    }

    /* === MODAL OVERLAY === */
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.26);
      display: none;
      align-items: flex-end;
      justify-content: center;
      padding: var(--s-3);
      z-index: 100;
    }

    .overlay.open {
      display: flex;
    }

    /* === SHEET (Bottom Modal) === */
    .sheet {
      width: 100%;
      max-width: 560px;
      max-height: 85vh;
      overflow-y: auto;
      border: 3px solid var(--ink-primary);
      border-radius: var(--radius-xl);
      background: var(--bg-card);
      box-shadow: var(--shadow-soft);
      padding: var(--s-3);
      animation: slideUp var(--motion-base) var(--ease-out);
    }

    .sheet h2 {
      margin: 0 0 var(--s-1);
      font-size: var(--text-xl);
      font-weight: 900;
      letter-spacing: -0.02em;
      text-align: center;
    }

    .sheet > p {
      margin: 0 0 var(--s-3);
      color: var(--ink-secondary);
      font-weight: 800;
      font-size: var(--text-sm);
      text-align: center;
    }

    .sheet-actions {
      display: flex;
      gap: var(--s-2);
      margin-top: var(--s-3);
    }

    .sheet-actions .btn {
      flex: 1;
    }

    /* === SETTINGS === */
    .settings-group {
      background: var(--bg-muted);
      border: 2px solid var(--ink-primary);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--s-2);
      min-height: 56px;
    }

    .setting-row + .setting-row {
      border-top: 2px solid var(--ink-primary);
    }

    .setting-label {
      font-weight: 900;
      font-size: var(--text-sm);
      color: var(--ink-primary);
    }

    /* === TOGGLE === */
    .toggle {
      width: 52px;
      height: 32px;
      background: var(--bg-canvas);
      border: 2px solid var(--ink-primary);
      border-radius: 16px;
      position: relative;
      cursor: pointer;
      transition: background var(--motion-fast) var(--ease-out);
    }

    .toggle::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background: var(--bg-card);
      border: 2px solid var(--ink-primary);
      border-radius: 12px;
      top: 2px;
      left: 2px;
      transition: left var(--motion-fast) var(--ease-out);
    }

    .toggle.on {
      background: var(--color-success);
      border-color: var(--color-success);
    }

    .toggle.on::after {
      left: 22px;
      border-color: var(--color-success);
    }

    /* === STATS MODAL === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--s-2);
      margin-bottom: var(--s-3);
    }

    .stat-card {
      background: var(--bg-muted);
      border: 2px solid var(--ink-primary);
      border-radius: var(--radius-md);
      padding: var(--s-2);
      text-align: center;
    }

    .stat-card-value {
      font-size: var(--text-2xl);
      font-weight: 900;
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }

    .stat-card-label {
      font-size: var(--text-xs);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ink-secondary);
      margin-top: 4px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: var(--s-1);
    }

    .history-item {
      padding: var(--s-2);
      border-radius: var(--radius-sm);
      border: 2px solid var(--ink-primary);
      font-weight: 900;
      font-size: var(--text-sm);
      display: flex;
      align-items: center;
      gap: var(--s-1);
    }

    .history-item.correct {
      background: var(--color-success-bg);
      border-color: var(--color-success);
      color: #2D5A3A;
    }

    .history-item.incorrect {
      background: var(--color-error-bg);
      border-color: var(--color-error);
      color: #6B3A32;
    }

    /* === EXPLANATION === */
    .explain-section {
      background: var(--bg-muted);
      border: 2px solid var(--ink-primary);
      border-radius: var(--radius-md);
      padding: var(--s-3);
      margin-bottom: var(--s-2);
    }

    .explain-title {
      font-weight: 900;
      font-size: var(--text-sm);
      color: var(--accent);
      margin-bottom: var(--s-2);
      display: flex;
      align-items: center;
      gap: var(--s-1);
    }

    .explain-result {
      background: var(--accent);
      color: white;
      padding: var(--s-2);
      border-radius: var(--radius-md);
      border: 2px solid var(--accent-dark);
      text-align: center;
      font-weight: 900;
      font-size: var(--text-lg);
    }

    .explain-tip {
      background: var(--color-warn-bg);
      border: 2px solid var(--color-warn);
      border-radius: var(--radius-sm);
      padding: var(--s-2);
      font-size: var(--text-sm);
      font-weight: 800;
      color: #6B5A32;
      margin-top: var(--s-2);
    }

    /* === K√ÑSTCHEN-GRID (Schriftliches Rechnen) === */
    .calc-grid-wrap {
      display: flex;
      justify-content: center;
      padding: var(--s-2) 0;
    }

    .calc-grid {
      display: inline-grid;
      gap: 0;
      background: var(--bg-card);
      border: 2px solid var(--ink-primary);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .calc-cell {
      width: 32px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font);
      font-size: var(--text-lg);
      font-weight: 900;
      color: var(--ink-primary);
      border-right: 1px solid var(--bg-muted);
      border-bottom: 1px solid var(--bg-muted);
      background: var(--bg-card);
    }

    .calc-cell:last-child {
      border-right: none;
    }

    .calc-cell.op {
      color: var(--accent);
      font-size: var(--text-xl);
    }

    .calc-cell.carry {
      font-size: var(--text-xs);
      color: var(--color-error);
      height: 24px;
    }

    .calc-cell.result {
      background: var(--color-success-bg);
      color: var(--color-success);
      font-weight: 900;
    }

    .calc-cell.highlight {
      background: var(--color-warn-bg);
    }

    .calc-cell.line-above {
      border-top: 3px solid var(--ink-primary);
    }

    .calc-cell.line-below {
      border-bottom: 3px solid var(--ink-primary);
    }

    .calc-cell.empty {
      background: transparent;
      border-color: transparent;
    }

    .calc-cell.spacer {
      width: 16px;
      background: transparent;
      border: none;
    }

    .calc-cell.dot {
      width: 12px;
      font-size: var(--text-sm);
    }

    /* Division: Spezielle Darstellung */
    .calc-division {
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: flex-start;
    }

    .calc-div-header {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: var(--s-1);
      background: var(--bg-card);
      border: 2px solid var(--ink-primary);
      border-radius: var(--radius-sm);
      font-family: var(--font);
      font-weight: 900;
      font-size: var(--text-lg);
    }

    .calc-div-step {
      display: flex;
      gap: 0;
      margin-left: 8px;
    }

    .calc-div-step .calc-cell {
      border: 1px solid var(--bg-muted);
    }

    .calc-div-step.subtract {
      color: var(--color-error);
    }

    .calc-div-step.remainder .calc-cell {
      background: var(--color-warn-bg);
    }

    /* Responsive f√ºr kleine Screens */
    @media (max-width: 360px) {
      .calc-cell {
        width: 26px;
        height: 30px;
        font-size: var(--text-md);
      }
      .calc-cell.carry {
        height: 20px;
        font-size: 10px;
      }
    }

    /* === ANIMATIONS === */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === RESPONSIVE === */
    @media (max-width: 400px) {
      header { padding: 0 var(--s-2); }
      .viewport { padding: var(--s-2); }
      footer { padding: var(--s-2); }
      
      .brand-title { font-size: var(--text-lg); }
      .pill { padding: 8px 10px; min-height: 44px; }
      .pill .val { font-size: var(--text-xs); }
      
      .grade-btn { min-height: 48px; font-size: var(--text-md); }
      .answer-btn { font-size: 1.25rem; min-height: 56px; }
      .btn { min-height: 48px; font-size: var(--text-sm); }
    }
  </style>
</head>

<body>
  <div class="app-frame">
    
    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="brand-title">‚àë Mathe √ºben</div>
        <div class="brand-subtitle">Kidsneed</div>
      </div>
      <div class="header-stats">
        <div class="pill" id="stats-pill" role="button" tabindex="0" aria-label="Statistiken">
          <span class="icon">‚úì</span>
          <span class="val" id="score">0</span>/<span class="val" id="total">0</span>
        </div>
        <div class="pill" aria-label="Serie">
          <span class="icon">üî•</span>
          <span class="val" id="streak">0</span>
        </div>
      </div>
    </header>

    <!-- MAIN VIEWPORT -->
    <main class="viewport">
      <div class="card">
        
        <!-- Klassenstufe -->
        <section class="card-section">
          <div class="section-label">Klassenstufe</div>
          <div class="grade-grid" id="grades">
            <button class="grade-btn selected" data-g="1" type="button">1</button>
            <button class="grade-btn" data-g="2" type="button">2</button>
            <button class="grade-btn" data-g="3" type="button">3</button>
            <button class="grade-btn" data-g="4" type="button">4</button>
          </div>
          <div class="icon-row">
            <button class="icon-btn" id="snd" aria-label="Ton">üîä</button>
            <button class="icon-btn" id="settings-btn" aria-label="Einstellungen">‚öôÔ∏è</button>
          </div>
        </section>

        <!-- Aufgabe -->
        <section class="card-section">
          <div class="task-container">
            <div class="timer" id="timer">
              <span>‚è±</span>
              <span id="time">30</span>s
            </div>
            <div class="task-area">
              <div class="task-text" id="task">Tippe auf ‚ÄûNeue Aufgabe"</div>
            </div>
          </div>

          <div class="answers" id="answers"></div>

          <div class="feedback" id="feedback">
            <span class="ficon">üìù</span>
            <span>W√§hle eine Klasse und starte.</span>
          </div>

          <div class="history-dots" id="history-dots"></div>
        </section>

        <!-- Aktionen -->
        <section class="card-section">
          <div class="actions">
            <button class="btn" id="help-btn" disabled type="button">üí° Erkl√§rung</button>
            <button class="btn primary" id="start-btn" type="button">Neue Aufgabe</button>
          </div>
        </section>

      </div>
    </main>

    <!-- FOOTER -->
    <footer>
      <a class="btn" href="https://humaneed.github.io/kidsneed/" aria-label="Zur√ºck zum Hub">‚Üê Hub</a>
      <button class="btn" id="stats-btn" type="button">üìä Statistik</button>
    </footer>

    <!-- MODAL: Erkl√§rung -->
    <div class="overlay" id="modal-help">
      <div class="sheet">
        <h2>üí° Erkl√§rung</h2>
        <div id="help-content"></div>
        <div class="sheet-actions">
          <button class="btn primary" id="ok-help" type="button">Verstanden</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Einstellungen -->
    <div class="overlay" id="modal-settings">
      <div class="sheet">
        <h2>‚öôÔ∏è Einstellungen</h2>
        <p>Passe dein √úbungserlebnis an.</p>
        <div class="settings-group">
          <div class="setting-row">
            <span class="setting-label">Timer (30s)</span>
            <div class="toggle" id="toggle-timer" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
          <div class="setting-row">
            <span class="setting-label">T√∂ne</span>
            <div class="toggle on" id="toggle-sound" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
          <div class="setting-row">
            <span class="setting-label">Tastaturk√ºrzel</span>
            <div class="toggle on" id="toggle-keyboard" role="switch" aria-checked="true" tabindex="0"></div>
          </div>
        </div>
        <div class="sheet-actions">
          <button class="btn primary" id="ok-settings" type="button">Fertig</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Statistiken -->
    <div class="overlay" id="modal-stats">
      <div class="sheet">
        <h2>üìä Deine Statistiken</h2>
        <div id="stats-content"></div>
        <div class="sheet-actions">
          <button class="btn primary" id="ok-stats" type="button">Schlie√üen</button>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  'use strict';

  const $ = id => document.getElementById(id);

  // === STATE ===
  const state = {
    grade: 1,
    score: 0,
    total: 0,
    streak: 0,
    maxStreak: 0,
    currentTask: null,
    answered: false,
    history: [],
    settings: { timer: false, sound: true, keyboard: true },
    timerValue: 30,
    timerInterval: null
  };

  // === HELPERS ===
  const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  const saveState = () => {
    try {
      localStorage.setItem('kidsneed_math', JSON.stringify({
        score: state.score,
        total: state.total,
        streak: state.streak,
        maxStreak: state.maxStreak,
        history: state.history.slice(-20),
        settings: state.settings,
        grade: state.grade
      }));
    } catch {}
  };

  const loadState = () => {
    try {
      const saved = JSON.parse(localStorage.getItem('kidsneed_math'));
      if (saved) {
        Object.assign(state, {
          score: saved.score || 0,
          total: saved.total || 0,
          streak: saved.streak || 0,
          maxStreak: saved.maxStreak || 0,
          history: saved.history || [],
          grade: saved.grade || 1
        });
        state.settings = { ...state.settings, ...saved.settings };

        document.querySelectorAll('.grade-btn').forEach(btn => {
          btn.classList.toggle('selected', +btn.dataset.g === state.grade);
        });

        $('toggle-timer').classList.toggle('on', state.settings.timer);
        $('toggle-sound').classList.toggle('on', state.settings.sound);
        $('toggle-keyboard').classList.toggle('on', state.settings.keyboard);
        $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
      }
    } catch {}
  };

  // === TASK GENERATION ===
  const createTask = (grade) => {
    const types = grade === 1 ? ['add', 'sub'] : 
                  grade === 2 ? ['add', 'sub', 'mul'] :
                  grade === 3 ? ['add', 'sub', 'mul', 'div'] :
                  ['add', 'sub', 'mul', 'div', 'word'];
    
    const type = types[rand(0, types.length - 1)];
    if (type === 'word') return createWordTask(grade);
    
    let num1, num2, answer, op, symbol;
    
    if (type === 'add') {
      if (grade === 1) { num1 = rand(1, 10); num2 = rand(1, 10); }
      else if (grade === 2) { num1 = rand(10, 50); num2 = rand(10, 50); }
      else { num1 = rand(10, 999); num2 = rand(10, 999); }
      answer = num1 + num2; op = 'add'; symbol = '+';
    } else if (type === 'sub') {
      if (grade === 1) { answer = rand(1, 10); num2 = rand(1, answer); num1 = answer + num2; }
      else if (grade === 2) { answer = rand(10, 50); num2 = rand(10, answer); num1 = answer + num2; }
      else { answer = rand(10, 999); num2 = rand(10, answer); num1 = answer + num2; }
      op = 'sub'; symbol = '‚àí';
    } else if (type === 'mul') {
      if (grade === 2) { num1 = rand(2, 10); num2 = rand(2, 10); }
      else if (grade === 3) { num1 = rand(2, 12); num2 = rand(2, 12); }
      else { num1 = rand(2, 99); num2 = rand(2, 12); }
      answer = num1 * num2; op = 'mul'; symbol = '√ó';
    } else {
      if (grade === 3) { num2 = rand(2, 10); answer = rand(2, 10); }
      else { num2 = rand(2, 12); answer = rand(2, 99); }
      num1 = num2 * answer; op = 'div'; symbol = '√∑';
    }
    
    const options = [answer];
    while (options.length < 4) {
      let wrong = answer + rand(-10, 10) * (op === 'mul' ? 1.5 : 1);
      wrong = Math.round(wrong);
      if (wrong > 0 && !options.includes(wrong)) options.push(wrong);
    }
    options.sort(() => Math.random() - 0.5);
    
    return { num1, num2, answer, op, problem: `${num1} ${symbol} ${num2} = ?`, options, correctIndex: options.indexOf(answer), taskType: 'math' };
  };

  const createWordTask = (grade) => {
    const templates = [
      { text: "Anna hat {n1} √Ñpfel. Sie bekommt {n2} dazu. Wie viele hat sie jetzt?", op: "add" },
      { text: "Tom hat {n1} Bonbons. Er gibt {n2} ab. Wie viele bleiben?", op: "sub" },
      { text: "In einer Schachtel sind {n1} Stifte. Es gibt {n2} Schachteln. Wie viele Stifte insgesamt?", op: "mul" },
      { text: "Lisa hat {n1} Euro. Ein Spielzeug kostet {n2} Euro. Wie viele kann sie kaufen?", op: "div" }
    ];
    
    const validTemplates = templates.filter(t => 
      (t.op === 'add' || t.op === 'sub') || (grade >= 2 && t.op === 'mul') || (grade >= 3 && t.op === 'div')
    );
    
    const template = validTemplates[rand(0, validTemplates.length - 1)];
    let num1, num2, answer;
    
    if (template.op === 'add') { num1 = rand(3, 20); num2 = rand(3, 20); answer = num1 + num2; }
    else if (template.op === 'sub') { answer = rand(3, 20); num2 = rand(1, answer - 1); num1 = answer + num2; }
    else if (template.op === 'mul') { num1 = rand(2, 10); num2 = rand(2, 10); answer = num1 * num2; }
    else { num2 = rand(2, 8); answer = rand(2, 12); num1 = num2 * answer; }
    
    const text = template.text.replace('{n1}', num1).replace('{n2}', num2);
    const options = [answer];
    while (options.length < 4) {
      const wrong = answer + rand(-8, 8);
      if (wrong > 0 && !options.includes(wrong)) options.push(wrong);
    }
    options.sort(() => Math.random() - 0.5);
    
    return { num1, num2, answer, op: template.op, problem: text, options, correctIndex: options.indexOf(answer), taskType: 'word' };
  };

  // === EXPLANATIONS (K√§stchen-Grid) ===
  
  // Hilfsfunktion: Zahl in Ziffern-Array
  const toDigits = (n) => String(n).split('').map(d => d);
  
  // Hilfsfunktion: Grid-Zeile erstellen
  const gridRow = (cells, cols) => {
    let html = '';
    // Padding links mit leeren Zellen
    const padding = cols - cells.length;
    for (let i = 0; i < padding; i++) {
      html += `<div class="calc-cell empty"></div>`;
    }
    cells.forEach(cell => {
      const classes = ['calc-cell'];
      if (cell.class) classes.push(cell.class);
      html += `<div class="${classes.join(' ')}">${cell.val ?? ''}</div>`;
    });
    return html;
  };

  // Addition mit K√§stchen
  const generateAdditionGrid = (num1, num2, answer) => {
    const d1 = toDigits(num1);
    const d2 = toDigits(num2);
    const dR = toDigits(answer);
    const cols = Math.max(d1.length, d2.length, dR.length) + 1; // +1 f√ºr Operator
    
    // √úbertrag berechnen
    const carries = [];
    let carry = 0;
    for (let i = 0; i < cols - 1; i++) {
      const digit1 = parseInt(d1[d1.length - 1 - i]) || 0;
      const digit2 = parseInt(d2[d2.length - 1 - i]) || 0;
      const sum = digit1 + digit2 + carry;
      carries.unshift(sum >= 10 ? 1 : 0);
      carry = sum >= 10 ? 1 : 0;
    }
    
    let html = `<div class="calc-grid-wrap"><div class="calc-grid" style="grid-template-columns: repeat(${cols}, auto);">`;
    
    // √úbertrag-Zeile (wenn vorhanden)
    if (carries.some(c => c > 0)) {
      const carryRow = [{ val: '', class: 'carry' }]; // Operator-Spalte
      for (let i = 0; i < cols - 1; i++) {
        const idx = carries.length - (cols - 1) + i;
        carryRow.push({ val: carries[idx] > 0 ? '¬π' : '', class: 'carry' });
      }
      html += gridRow(carryRow, cols);
    }
    
    // Erste Zahl
    const row1 = [{ val: '', class: 'empty' }];
    d1.forEach(d => row1.push({ val: d }));
    html += gridRow(row1, cols);
    
    // Zweite Zahl mit Operator
    const row2 = [{ val: '+', class: 'op' }];
    d2.forEach(d => row2.push({ val: d }));
    html += gridRow(row2, cols);
    
    // Ergebnis mit Linie
    const rowR = [{ val: '', class: 'line-above' }];
    dR.forEach(d => rowR.push({ val: d, class: 'line-above result' }));
    html += gridRow(rowR, cols);
    
    html += `</div></div>`;
    return html;
  };

  // Subtraktion mit K√§stchen
  const generateSubtractionGrid = (num1, num2, answer) => {
    const d1 = toDigits(num1);
    const d2 = toDigits(num2);
    const dR = toDigits(answer);
    const cols = Math.max(d1.length, d2.length, dR.length) + 1;
    
    let html = `<div class="calc-grid-wrap"><div class="calc-grid" style="grid-template-columns: repeat(${cols}, auto);">`;
    
    // Erste Zahl
    const row1 = [{ val: '', class: 'empty' }];
    d1.forEach(d => row1.push({ val: d }));
    html += gridRow(row1, cols);
    
    // Zweite Zahl mit Operator
    const row2 = [{ val: '‚àí', class: 'op' }];
    d2.forEach(d => row2.push({ val: d }));
    html += gridRow(row2, cols);
    
    // Ergebnis mit Linie
    const rowR = [{ val: '', class: 'line-above' }];
    dR.forEach(d => rowR.push({ val: d, class: 'line-above result' }));
    html += gridRow(rowR, cols);
    
    html += `</div></div>`;
    return html;
  };

  // Multiplikation mit K√§stchen (wie im Bild: mit Zwischenergebnissen)
  const generateMultiplicationGrid = (num1, num2, answer) => {
    const d1 = toDigits(num1);
    const d2 = toDigits(num2);
    const dR = toDigits(answer);
    
    // Zwischenergebnisse berechnen
    const partials = [];
    for (let i = d2.length - 1; i >= 0; i--) {
      const digit = parseInt(d2[i]);
      const partial = num1 * digit;
      const zeros = d2.length - 1 - i;
      partials.push({ value: partial, zeros, digits: toDigits(partial) });
    }
    
    // Maximale Breite berechnen
    const maxLen = Math.max(
      d1.length + 1,
      d2.length + 1,
      ...partials.map(p => p.digits.length + p.zeros),
      dR.length
    );
    const cols = maxLen + 1; // +1 f√ºr Operator
    
    let html = `<div class="calc-grid-wrap"><div class="calc-grid" style="grid-template-columns: repeat(${cols}, auto);">`;
    
    // Erste Zahl
    const row1 = [{ val: '', class: 'empty' }];
    d1.forEach(d => row1.push({ val: d }));
    html += gridRow(row1, cols);
    
    // Zweite Zahl mit Operator
    const row2 = [{ val: '¬∑', class: 'op' }];
    d2.forEach(d => row2.push({ val: d }));
    html += gridRow(row2, cols);
    
    // Zwischenergebnisse
    partials.forEach((p, idx) => {
      const cells = idx === 0 ? [{ val: '', class: 'line-above' }] : [{ val: '', class: 'empty' }];
      p.digits.forEach((d, di) => {
        cells.push({ val: d, class: idx === 0 ? 'line-above' : '' });
      });
      // Nullen am Ende (Stellenwert)
      for (let z = 0; z < p.zeros; z++) {
        cells.push({ val: '', class: 'empty' });
      }
      html += gridRow(cells, cols);
    });
    
    // Endergebnis (nur wenn mehr als ein Zwischenergebnis)
    if (partials.length > 1) {
      const rowR = [{ val: '', class: 'line-above' }];
      dR.forEach(d => rowR.push({ val: d, class: 'line-above result' }));
      html += gridRow(rowR, cols);
    } else {
      // Bei einstelligem Multiplikator: Ergebnis hervorheben
      // (bereits in Zwischenergebnis enthalten)
    }
    
    html += `</div></div>`;
    return html;
  };

  // Division mit K√§stchen (wie im Bild: 735:3=245)
  const generateDivisionGrid = (dividend, divisor, quotient) => {
    const dDividend = toDigits(dividend);
    const dQuotient = toDigits(quotient);
    
    // Schritte der Division berechnen
    const steps = [];
    let remainder = 0;
    let currentDigitIdx = 0;
    
    for (let i = 0; i < dDividend.length; i++) {
      const current = remainder * 10 + parseInt(dDividend[i]);
      
      if (current >= divisor || steps.length > 0) {
        const q = Math.floor(current / divisor);
        const product = q * divisor;
        const newRemainder = current - product;
        
        steps.push({
          current,
          quotientDigit: q,
          product,
          remainder: newRemainder,
          position: i
        });
        
        remainder = newRemainder;
      } else {
        remainder = current;
      }
    }
    
    // Breite berechnen
    const cols = Math.max(dDividend.length + 4, dQuotient.length + 6);
    
    let html = `<div class="calc-grid-wrap">`;
    html += `<div style="text-align: left;">`;
    
    // Kopfzeile: dividend : divisor = quotient
    html += `<div class="calc-div-header">`;
    html += `<span>${dividend}</span>`;
    html += `<span style="color: var(--accent);">:</span>`;
    html += `<span>${divisor}</span>`;
    html += `<span style="color: var(--accent);">=</span>`;
    html += `<span style="color: var(--color-success);">${quotient}</span>`;
    html += `</div>`;
    
    // Rechenschritte
    html += `<div style="margin-top: var(--s-2); font-family: var(--font); font-weight: 900;">`;
    
    steps.forEach((step, idx) => {
      // Subtrahend (das Produkt)
      html += `<div style="display: flex; align-items: center; gap: 4px; margin: 4px 0;">`;
      html += `<span style="color: var(--color-error); width: 20px;">‚àí</span>`;
      html += `<span style="min-width: 40px;">${step.product}</span>`;
      html += `</div>`;
      
      // Linie und Rest
      html += `<div style="display: flex; align-items: center; gap: 4px; margin: 4px 0; padding-left: 24px; border-top: 2px solid var(--ink-primary);">`;
      
      // Rest + n√§chste Ziffer (wenn vorhanden)
      const nextDigitIdx = step.position + 1;
      if (nextDigitIdx < dDividend.length) {
        const nextDigit = dDividend[nextDigitIdx];
        html += `<span style="background: var(--color-warn-bg); padding: 2px 6px; border-radius: 4px;">${step.remainder}${nextDigit}</span>`;
      } else {
        html += `<span style="background: var(--color-success-bg); padding: 2px 6px; border-radius: 4px;">${step.remainder}</span>`;
      }
      
      html += `</div>`;
    });
    
    html += `</div>`;
    html += `</div>`;
    html += `</div>`;
    
    return html;
  };

  const generateExplanation = (task) => {
    const { num1, num2, answer, op } = task;
    let html = '';
    
    // Rechenweg mit K√§stchen
    html += `<div class="explain-section">`;
    html += `<div class="explain-title">üìù Rechenweg</div>`;
    
    if (op === 'add') {
      html += generateAdditionGrid(num1, num2, answer);
    } else if (op === 'sub') {
      html += generateSubtractionGrid(num1, num2, answer);
    } else if (op === 'mul') {
      html += generateMultiplicationGrid(num1, num2, answer);
    } else if (op === 'div') {
      html += generateDivisionGrid(num1, num2, answer);
    }
    
    html += `</div>`;
    
    // Ergebnis
    html += `<div class="explain-result">üéâ Die Antwort ist ${answer}</div>`;
    
    // Tipps je nach Rechenart
    if (op === 'add') {
      html += `<div class="explain-tip">üí° Tipp: Du kannst auch ${num2} + ${num1} rechnen ‚Äì das Ergebnis ist gleich!</div>`;
    } else if (op === 'mul' && num2 <= 5) {
      html += `<div class="explain-tip">üí° Das bedeutet: ${Array(num2).fill(num1).join(' + ')} = ${answer}</div>`;
    } else if (op === 'div') {
      html += `<div class="explain-tip">üí° Probe: ${answer} √ó ${num2} = ${num1}</div>`;
    }
    
    return html;
  };

  // === SOUND (Simple Beeps) ===
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  const playBeep = (frequency, duration, type = 'sine') => {
    if (!state.settings.sound) return;
    
    // Ensure AudioContext is running (required after user interaction)
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    oscillator.type = type;
    oscillator.frequency.value = frequency;
    
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    
    oscillator.start(audioCtx.currentTime);
    oscillator.stop(audioCtx.currentTime + duration);
  };
  
  const playCorrect = () => {
    // Aufsteigender Doppelton (fr√∂hlich)
    playBeep(523, 0.12); // C5
    setTimeout(() => playBeep(659, 0.15), 100); // E5
  };
  
  const playIncorrect = () => {
    // Tiefer, kurzer Ton (sanft)
    playBeep(294, 0.2, 'triangle'); // D4
  };
  
  const playClick = () => {
    // Kurzer Klick-Sound
    playBeep(880, 0.05); // A5
  };

  // === TIMER ===
  const startTimer = () => {
    if (!state.settings.timer) return;
    stopTimer();
    state.timerValue = 30;
    $('timer').classList.add('active');
    $('timer').classList.remove('warning');
    $('time').textContent = state.timerValue;
    
    state.timerInterval = setInterval(() => {
      state.timerValue--;
      $('time').textContent = state.timerValue;
      if (state.timerValue <= 10) $('timer').classList.add('warning');
      if (state.timerValue <= 0) {
        stopTimer();
        if (!state.answered) {
          answerQuestion(-1);
          showFeedback('‚è±Ô∏è Zeit abgelaufen!', 'error');
        }
      }
    }, 1000);
  };

  const stopTimer = () => {
    if (state.timerInterval) {
      clearInterval(state.timerInterval);
      state.timerInterval = null;
    }
    $('timer').classList.remove('active');
  };

  // === UI UPDATES ===
  const updateStats = () => {
    $('score').textContent = state.score;
    $('total').textContent = state.total;
    $('streak').textContent = state.streak;
  };

  const updateHistoryDots = () => {
    $('history-dots').innerHTML = state.history.slice(-10).map(item => 
      `<div class="dot ${item.correct ? 'correct' : 'incorrect'}">${item.correct ? '‚úì' : '‚úó'}</div>`
    ).join('');
  };

  const showFeedback = (text, type = '') => {
    const fb = $('feedback');
    fb.className = 'feedback' + (type ? ' ' + type : '');
    fb.innerHTML = `<span class="ficon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üìù'}</span><span>${text}</span>`;
  };

  // === MODALS ===
  const openModal = (id) => {
    $(id).classList.add('open');
  };

  const closeModal = (id) => {
    $(id).classList.remove('open');
  };

  const showStatsModal = () => {
    const accuracy = state.total > 0 ? Math.round((state.score / state.total) * 100) : 0;
    
    let html = `<div class="stats-grid">
      <div class="stat-card"><div class="stat-card-value">${state.total}</div><div class="stat-card-label">Aufgaben</div></div>
      <div class="stat-card"><div class="stat-card-value">${state.score}</div><div class="stat-card-label">Richtig</div></div>
      <div class="stat-card"><div class="stat-card-value">${accuracy}%</div><div class="stat-card-label">Genauigkeit</div></div>
      <div class="stat-card"><div class="stat-card-value">${state.maxStreak}</div><div class="stat-card-label">Beste Serie</div></div>
    </div>`;
    
    if (state.history.length > 0) {
      html += `<div class="section-label">Letzte Aufgaben</div>`;
      html += `<div class="history-list">`;
      html += state.history.slice(-8).reverse().map(item => 
        `<div class="history-item ${item.correct ? 'correct' : 'incorrect'}">${item.correct ? '‚úì' : '‚úó'} ${item.problem}</div>`
      ).join('');
      html += `</div>`;
    }
    
    $('stats-content').innerHTML = html;
    openModal('modal-stats');
  };

  // === GAME LOGIC ===
  const startNewTask = () => {
    state.currentTask = createTask(state.grade);
    state.answered = false;
    
    const taskEl = $('task');
    taskEl.textContent = state.currentTask.problem;
    taskEl.className = 'task-text' + (state.currentTask.taskType === 'word' ? ' word-problem' : '');
    
    showFeedback('Tippe auf die richtige L√∂sung');
    $('help-btn').disabled = false;
    
    const answersEl = $('answers');
    answersEl.innerHTML = '';
    state.currentTask.options.forEach((option, index) => {
      const btn = document.createElement('button');
      btn.className = 'answer-btn';
      btn.type = 'button';
      btn.textContent = option;
      btn.onclick = () => answerQuestion(index);
      answersEl.appendChild(btn);
    });
    
    startTimer();
    playClick();
  };

  const answerQuestion = (selectedIndex) => {
    if (state.answered) return;
    state.answered = true;
    stopTimer();
    
    const buttons = $('answers').querySelectorAll('.answer-btn');
    const correctIndex = state.currentTask.correctIndex;
    const isCorrect = selectedIndex === correctIndex;
    
    buttons[correctIndex].classList.add('correct');
    
    state.total++;
    
    if (isCorrect) {
      state.score++;
      state.streak++;
      if (state.streak > state.maxStreak) state.maxStreak = state.streak;
      showFeedback('Richtig! Super gemacht!', 'success');
      playCorrect();
    } else {
      state.streak = 0;
      if (selectedIndex >= 0) buttons[selectedIndex].classList.add('incorrect');
      showFeedback(`Fast! Die Antwort ist ${state.currentTask.options[correctIndex]}`, 'error');
      playIncorrect();
    }
    
    state.history.push({
      problem: state.currentTask.problem.replace('?', state.currentTask.options[correctIndex]),
      correct: isCorrect
    });
    
    updateStats();
    updateHistoryDots();
    saveState();
  };

  // === EVENT LISTENERS ===

  // Grade selection
  $('grades').onclick = e => {
    const btn = e.target.closest('.grade-btn');
    if (!btn) return;
    
    state.grade = +btn.dataset.g;
    document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    saveState();
  };

  // Main buttons
  $('start-btn').onclick = startNewTask;

  $('help-btn').onclick = () => {
    if (!state.currentTask) return;
    $('help-content').innerHTML = generateExplanation(state.currentTask);
    openModal('modal-help');
  };

  $('stats-btn').onclick = showStatsModal;
  $('stats-pill').onclick = showStatsModal;
  $('settings-btn').onclick = () => openModal('modal-settings');

  // Sound toggle
  $('snd').onclick = () => {
    state.settings.sound = !state.settings.sound;
    $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
    $('toggle-sound').classList.toggle('on', state.settings.sound);
    saveState();
  };

  // Settings toggles
  $('toggle-timer').onclick = () => {
    state.settings.timer = !state.settings.timer;
    $('toggle-timer').classList.toggle('on');
    if (!state.settings.timer) stopTimer();
    saveState();
  };

  $('toggle-sound').onclick = () => {
    state.settings.sound = !state.settings.sound;
    $('toggle-sound').classList.toggle('on');
    $('snd').textContent = state.settings.sound ? 'üîä' : 'üîá';
    saveState();
  };

  $('toggle-keyboard').onclick = () => {
    state.settings.keyboard = !state.settings.keyboard;
    $('toggle-keyboard').classList.toggle('on');
    saveState();
  };

  // Modal close
  ['help', 'settings', 'stats'].forEach(name => {
    $(`ok-${name}`).onclick = () => closeModal(`modal-${name}`);
    $(`modal-${name}`).onclick = e => {
      if (e.target === $(`modal-${name}`)) closeModal(`modal-${name}`);
    };
  });

  // Keyboard
  document.onkeydown = e => {
    if (!state.settings.keyboard) return;
    
    if (e.key === 'Escape') {
      ['help', 'settings', 'stats'].forEach(name => closeModal(`modal-${name}`));
      return;
    }
    
    if (document.querySelector('.overlay.open')) return;
    
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      $('start-btn').click();
    } else if (e.key.toLowerCase() === 'e' && state.currentTask) {
      $('help-btn').click();
    } else if ('1234'.includes(e.key)) {
      const btn = $('answers').querySelectorAll('.answer-btn')[+e.key - 1];
      if (btn) btn.click();
    }
  };

  // === INIT ===
  loadState();
  updateStats();
  updateHistoryDots();
  
  console.log('‚úÖ Mathe √ºben geladen.');
})();
</script>
</body>
</html>
