<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#4A7C91" />
  <meta name="description" content="Learn90 Mathe-App PRO ‚Äì Visuelle Rechenwege" />
  <title>Learn90 Mathe PRO ‚Äì Vorschule bis Klasse 4</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700;800;900&family=Fira+Mono:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --s-1: 8px; --s-2: 16px; --s-3: 24px; --s-4: 32px; --s-5: 48px;
      --radius-sm: 12px; --radius-md: 16px; --radius-lg: 24px; --radius-xl: 28px;
      --bg-canvas: #F5F0E8; --bg-card: #FFFFFF; --bg-muted: #EDE8DC;
      --ink-primary: #2D2A26; --ink-secondary: #6B665C; --ink-light: #9C9588;
      --col-math: #4A7C91; --col-highlight: #C9A66B;
      --feedback-success: #7BA08A; --feedback-error: #C4726C;
      --shadow-subtle: 0 1px 3px rgba(45, 42, 38, 0.06);
      --shadow-soft: 0 2px 8px rgba(45, 42, 38, 0.08);
      --shadow-medium: 0 4px 16px rgba(45, 42, 38, 0.12);
      --hover-lift: translateY(-1px);
      --text-xs: 11px; --text-sm: 12px; --text-base: 14px;
      --text-md: 16px; --text-lg: 18px; --text-xl: 20px; --text-2xl: 24px;
      --motion-fast: 150ms; --motion-base: 300ms; --motion-slow: 500ms;
      --ease-out: cubic-bezier(0.33, 1, 0.68, 1);
      --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
      --app-max-w: 480px; --accent: var(--col-math);
      --font: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'Fira Mono', 'Courier New', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    input, textarea, select { user-select: text; }
    *:focus-visible { outline: 3px solid var(--accent); outline-offset: 2px; border-radius: var(--radius-sm); }
    button:focus-visible { transform: scale(1.02); transition: transform var(--motion-fast) var(--ease-out); }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    @media (prefers-contrast: high) {
      .btn-answer, .level-btn { border-width: 4px; }
      *:focus-visible { outline-width: 4px; }
    }

    body {
      margin: 0; padding: 0; background: var(--bg-canvas);
      font-family: var(--font); font-weight: 500; font-size: var(--text-md); line-height: 1.5;
      color: var(--ink-primary); height: 100dvh; width: 100vw; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }

    #app-frame {
      background: var(--bg-card); width: 100%; height: 100%;
      position: relative; display: flex; flex-direction: column; overflow: hidden;
    }

    @media (min-width: 480px) { body { padding: var(--s-2); } }
    @media (min-width: 520px) {
      body { padding: var(--s-3); }
      #app-frame {
        max-width: var(--app-max-w); height: 94dvh; max-height: 860px;
        border-radius: var(--radius-lg); border: 3px solid var(--ink-primary);
        box-shadow: var(--shadow-subtle);
      }
    }

    header {
      flex: 0 0 auto; height: 72px; padding: 0 var(--s-3);
      display: flex; align-items: center; justify-content: space-between;
      background: var(--bg-card); border-bottom: 3px solid var(--ink-primary);
    }
    .brand { display: flex; flex-direction: column; gap: 2px; }
    .brand-title { font-size: var(--text-xl); font-weight: 900; letter-spacing: -0.02em; color: var(--ink-primary); }
    .brand-subtitle { font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--ink-secondary); }
    .score-badge {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg-muted); padding: 12px 16px; min-height: 48px;
      border-radius: var(--radius-sm); border: 2px solid var(--ink-primary);
      transition: transform var(--motion-base) var(--ease-out);
    }
    .score-badge.pulse { animation: scorePulse 0.4s var(--ease-bounce); }
    .score-badge span:first-child { font-size: var(--text-lg); }
    .score-badge span:last-child { font-size: var(--text-md); font-weight: 800; color: var(--ink-primary); }

    .viewport {
      flex: 1; overflow-y: auto; overflow-x: hidden; padding: var(--s-3);
      overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    .viewport::-webkit-scrollbar { width: 4px; }
    .viewport::-webkit-scrollbar-thumb { background: var(--ink-light); border-radius: 99px; }

    footer {
      flex: 0 0 auto; padding: var(--s-2) var(--s-3);
      padding-bottom: max(var(--s-2), env(safe-area-inset-bottom));
      background: var(--bg-card); border-top: 3px solid var(--ink-primary);
      display: flex; gap: var(--s-2);
    }
    .footer-btn {
      flex: 1; min-height: 48px; border: 2px solid var(--ink-primary); background: var(--bg-card);
      border-radius: var(--radius-sm); font-family: var(--font); font-weight: 700; font-size: var(--text-base);
      color: var(--ink-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
      transition: background var(--motion-fast) var(--ease-out), transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out);
    }
    .footer-btn:hover { background: rgba(0, 0, 0, 0.02); transform: var(--hover-lift); box-shadow: var(--shadow-soft); }
    .footer-btn:active { transform: translateY(1px); box-shadow: none; }
    .footer-btn.accent { color: var(--accent); font-weight: 800; }

    .level-selector {
      display: flex; gap: var(--s-1); margin-bottom: var(--s-3);
      justify-content: center; flex-wrap: wrap;
    }
    .level-btn {
      padding: 12px 16px; min-height: 48px; border: 2px solid var(--ink-primary);
      border-radius: var(--radius-sm); background: var(--bg-card);
      font-family: var(--font); font-weight: 700; font-size: var(--text-base);
      color: var(--ink-primary); cursor: pointer;
      transition: background var(--motion-fast) var(--ease-out), transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out);
    }
    .level-btn.active { background: var(--accent); color: var(--bg-card); }
    .level-btn:hover:not(.active) { background: rgba(0, 0, 0, 0.02); transform: var(--hover-lift); box-shadow: var(--shadow-soft); }
    .level-btn:active { transform: translateY(1px); }

    .task-card {
      background: var(--bg-card); border: 3px solid var(--ink-primary);
      border-radius: var(--radius-md); padding: var(--s-4) var(--s-3);
      text-align: center; margin-bottom: var(--s-3);
      animation: fadeIn var(--motion-base) var(--ease-out);
      box-shadow: var(--shadow-subtle);
    }
    .task-label { font-size: var(--text-sm); font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent); margin-bottom: var(--s-1); }
    .task-prompt { font-size: var(--text-2xl); font-weight: 900; line-height: 1.3; color: var(--ink-primary); white-space: pre-wrap; }
    .task-prompt.small { font-size: var(--text-lg); }

    .choices { display: grid; grid-template-columns: 1fr 1fr; gap: var(--s-2); max-width: 400px; margin: 0 auto; }
    .choices.single-col { grid-template-columns: 1fr; }
    .btn-answer {
      min-height: 64px; background: var(--bg-card); border: 3px solid var(--ink-primary);
      border-radius: var(--radius-lg); font-family: var(--font); font-size: var(--text-md); font-weight: 700;
      color: var(--ink-primary); cursor: pointer; display: flex; align-items: center; justify-content: center;
      padding: var(--s-2); white-space: pre-wrap; line-height: 1.3;
      transition: background var(--motion-fast) var(--ease-out), transform var(--motion-fast) var(--ease-out), box-shadow var(--motion-fast) var(--ease-out), border-color var(--motion-fast) var(--ease-out);
    }
    .btn-answer:hover:not(:disabled) { background: rgba(0, 0, 0, 0.02); transform: var(--hover-lift); box-shadow: var(--shadow-soft); }
    .btn-answer:active:not(:disabled) { transform: translateY(1px); box-shadow: none; }
    .btn-answer:disabled { cursor: not-allowed; }
    .btn-answer.correct {
      background: var(--feedback-success); border-color: var(--ink-primary); color: var(--bg-card);
      animation: celebrate var(--motion-slow) var(--ease-bounce);
    }
    .btn-answer.wrong {
      background: var(--feedback-error); border-color: var(--ink-primary); color: var(--bg-card);
      animation: shake 0.4s;
    }

    .explain-box { margin-top: var(--s-3); border: 3px solid var(--ink-primary); border-radius: var(--radius-md); overflow: hidden; background: var(--bg-card); }
    .explain-box summary {
      padding: var(--s-2); min-height: 48px; font-weight: 700; font-size: var(--text-base);
      cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: center;
      gap: 8px; color: var(--accent);
      transition: background var(--motion-fast) var(--ease-out);
    }
    .explain-box summary:hover { background: rgba(0, 0, 0, 0.02); }
    .explain-box summary::-webkit-details-marker { display: none; }
    .explain-box[open] summary { border-bottom: 2px solid var(--ink-primary); }
    .explain-content {
      padding: var(--s-3); font-size: var(--text-base); line-height: 1.6;
      background: var(--bg-muted); animation: slideDown var(--motion-base) var(--ease-out);
    }

    /* ‚ïê‚ïê‚ïê VISUAL MATH STYLES ‚ïê‚ïê‚ïê */
    .math-visual {
      background: var(--bg-card); border: 2px solid var(--ink-light);
      border-radius: var(--radius-sm); padding: var(--s-3);
      font-family: var(--font-mono); font-size: var(--text-md);
      line-height: 1.8; margin: var(--s-2) 0;
      text-align: left;
    }
    
    .math-steps {
      display: flex; flex-direction: column; gap: var(--s-2);
    }
    
    .math-step {
      padding: var(--s-2); background: var(--bg-muted);
      border-left: 3px solid var(--col-math);
      border-radius: 4px;
    }
    
    .math-step.highlight {
      background: rgba(74, 124, 145, 0.1);
      border-left-color: var(--col-highlight);
    }
    
    .math-step-label {
      font-size: var(--text-xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--col-math); margin-bottom: 4px;
      font-family: var(--font);
    }
    
    /* Rechenk√§stchen (untereinander) */
    .calc-box {
      display: inline-block;
      background: var(--bg-card);
      border: 2px solid var(--ink-primary);
      border-radius: var(--radius-sm);
      padding: var(--s-2);
      font-family: var(--font-mono);
      font-size: 18px;
      line-height: 1.6;
      text-align: right;
      margin: var(--s-2) auto;
    }
    
    .calc-row {
      display: flex;
      justify-content: flex-end;
      align-items: baseline;
      gap: 12px;
      min-height: 32px;
    }
    
    .calc-row.underline {
      border-bottom: 2px solid var(--ink-primary);
      padding-bottom: 4px;
      margin-bottom: 4px;
    }
    
    .calc-op {
      width: 24px;
      text-align: center;
      font-weight: 700;
    }
    
    .calc-num {
      min-width: 60px;
      text-align: right;
      font-weight: 700;
    }
    
    .calc-num.highlight {
      color: var(--col-math);
      font-weight: 900;
    }
    
    .calc-num.result {
      color: var(--feedback-success);
      font-weight: 900;
    }
    
    /* Z√§hlhilfe */
    .count-visual {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin: var(--s-2) 0;
    }
    
    .count-item {
      font-size: 32px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-muted);
      border: 2px solid var(--ink-light);
      border-radius: var(--radius-sm);
    }
    
    /* Zahlenstrahl */
    .number-line {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      margin: var(--s-3) 0;
      padding: var(--s-2);
      background: var(--bg-muted);
      border-radius: var(--radius-sm);
    }
    
    .number-node {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
      border: 2px solid var(--ink-primary);
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: var(--text-md);
    }
    
    .number-node.highlight {
      background: var(--col-math);
      color: var(--bg-card);
      transform: scale(1.15);
    }
    
    .number-node.arrow {
      border: none;
      background: transparent;
      font-size: 20px;
    }

    .streak-indicator { display: flex; justify-content: center; gap: 6px; margin-bottom: var(--s-2); }
    .streak-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--bg-muted); border: 2px solid var(--ink-light); transition: all var(--motion-base) var(--ease-out); }
    .streak-dot.filled { background: var(--feedback-success); border-color: var(--ink-primary); }

    @keyframes celebrate { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideDown { from { opacity: 0; max-height: 0; } to { opacity: 1; max-height: 1000px; } }
    @keyframes scorePulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

    @media (max-width: 360px) {
      .task-prompt { font-size: 20px; }
      .level-btn { padding: 10px 14px; font-size: 13px; }
      .calc-num { font-size: 16px; }
    }
    @media print {
      body { background: white; padding: 0; }
      header, footer { display: none !important; }
      #app-frame { border: 1px solid #000; box-shadow: none; max-width: 100%; height: auto; }
    }
  </style>
</head>
<body>

<div id="app-frame">
  <header>
    <div class="brand">
      <div class="brand-title" id="uiTitle">Mathe PRO</div>
      <div class="brand-subtitle" id="uiMode">Level w√§hlen</div>
    </div>
    <div class="score-badge" title="Punkte">
      <span>‚≠ê</span>
      <span id="coin-count">0</span>
    </div>
  </header>

  <div class="viewport" id="content"></div>

  <footer>
    <button class="footer-btn" id="btnBack" aria-label="Zur√ºck">‚Üê Zur√ºck</button>
    <button class="footer-btn accent" id="btnNext" aria-label="N√§chste Aufgabe">Weiter ‚Üí</button>
  </footer>
</div>

<script>
(() => {
  'use strict';
  
  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];
  const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const pick = arr => arr[Math.floor(Math.random() * arr.length)];
  const shuffle = arr => { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     VISUAL MATH HELPERS - Verbesserte Rechenwege
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  
  const VisualMath = {
    // Addition untereinander
    additionBox(a, b, result) {
      return `
        <div class="calc-box">
          <div class="calc-row">
            <span class="calc-op"></span>
            <span class="calc-num">${a}</span>
          </div>
          <div class="calc-row underline">
            <span class="calc-op">+</span>
            <span class="calc-num">${b}</span>
          </div>
          <div class="calc-row">
            <span class="calc-op">=</span>
            <span class="calc-num result">${result}</span>
          </div>
        </div>
      `;
    },
    
    // Subtraktion untereinander
    subtractionBox(a, b, result) {
      return `
        <div class="calc-box">
          <div class="calc-row">
            <span class="calc-op"></span>
            <span class="calc-num">${a}</span>
          </div>
          <div class="calc-row underline">
            <span class="calc-op">‚àí</span>
            <span class="calc-num">${b}</span>
          </div>
          <div class="calc-row">
            <span class="calc-op">=</span>
            <span class="calc-num result">${result}</span>
          </div>
        </div>
      `;
    },
    
    // Multiplikation untereinander
    multiplicationBox(a, b, result) {
      return `
        <div class="calc-box">
          <div class="calc-row">
            <span class="calc-op"></span>
            <span class="calc-num">${a}</span>
          </div>
          <div class="calc-row underline">
            <span class="calc-op">√ó</span>
            <span class="calc-num">${b}</span>
          </div>
          <div class="calc-row">
            <span class="calc-op">=</span>
            <span class="calc-num result">${result}</span>
          </div>
        </div>
      `;
    },
    
    // Division mit Rest
    divisionBox(dividend, divisor, quotient, remainder) {
      const steps = [];
      steps.push(`<div class="math-step"><div class="math-step-label">Schritt 1</div>${dividend} : ${divisor} = ?</div>`);
      steps.push(`<div class="math-step"><div class="math-step-label">Schritt 2</div>${divisor} √ó ${quotient} = ${divisor * quotient}</div>`);
      steps.push(`<div class="math-step highlight"><div class="math-step-label">Schritt 3 (Rest)</div>${dividend} ‚àí ${divisor * quotient} = ${remainder}</div>`);
      steps.push(`<div class="math-step"><div class="math-step-label">Ergebnis</div>${quotient} Rest ${remainder}</div>`);
      return `<div class="math-steps">${steps.join('')}</div>`;
    },
    
    // Zahlenstrahl
    numberLine(start, end, highlight) {
      const nodes = [];
      for (let i = start; i <= end; i++) {
        const isHighlight = Array.isArray(highlight) ? highlight.includes(i) : i === highlight;
        nodes.push(`<div class="number-node ${isHighlight ? 'highlight' : ''}">${i}</div>`);
        if (i < end) nodes.push(`<div class="number-node arrow">‚Üí</div>`);
      }
      return `<div class="number-line">${nodes.join('')}</div>`;
    },
    
    // Z√§hlhilfe mit Emojis
    countVisual(emoji, count) {
      return `<div class="count-visual">${emoji.repeat(count).split('').map(e => `<div class="count-item">${e}</div>`).join('')}</div>`;
    },
    
    // Zahlzerlegung visuell
    decompositionBox(num, tens, ones) {
      return `
        <div class="math-visual">
          <div style="text-align: center; margin-bottom: 12px; font-size: 24px; font-weight: 900;">${num}</div>
          <div style="display: flex; justify-content: space-around; align-items: center; margin: 16px 0;">
            <div style="text-align: center;">
              <div style="font-size: 14px; color: var(--col-math); font-weight: 700; margin-bottom: 8px;">ZEHNER</div>
              <div style="font-size: 32px; font-weight: 900; color: var(--col-math);">${tens}</div>
              <div style="font-size: 12px; margin-top: 4px;">(= ${tens * 10})</div>
            </div>
            <div style="font-size: 24px;">+</div>
            <div style="text-align: center;">
              <div style="font-size: 14px; color: var(--col-highlight); font-weight: 700; margin-bottom: 8px;">EINER</div>
              <div style="font-size: 32px; font-weight: 900; color: var(--col-highlight);">${ones}</div>
              <div style="font-size: 12px; margin-top: 4px;">(= ${ones})</div>
            </div>
          </div>
          <div style="text-align: center; margin-top: 16px; padding-top: 12px; border-top: 2px solid var(--ink-light);">
            ${tens * 10} + ${ones} = <strong>${num}</strong>
          </div>
        </div>
      `;
    },
    
    // Verdoppeln visuell
    doublingBox(num, doubled) {
      return `
        <div class="math-visual">
          <div class="math-steps">
            <div class="math-step">
              <div class="math-step-label">Ausgangszahl</div>
              ${num}
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Verdoppeln = 2√ó</div>
              ${num} √ó 2 = ${num} + ${num}
            </div>
            <div class="math-step">
              <div class="math-step-label">Ergebnis</div>
              ${this.additionBox(num, num, doubled)}
            </div>
          </div>
        </div>
      `;
    },
    
    // Halbieren visuell
    halvingBox(num, half) {
      return `
        <div class="math-visual">
          <div class="math-steps">
            <div class="math-step">
              <div class="math-step-label">Ausgangszahl</div>
              ${num}
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Halbieren = : 2</div>
              ${num} : 2 = ?
            </div>
            <div class="math-step">
              <div class="math-step-label">Ergebnis</div>
              <strong>${half}</strong> + <strong>${half}</strong> = ${num} ‚úì
            </div>
          </div>
        </div>
      `;
    },
    
    // Rechenpyramide visuell
    pyramidBox(base1, base2, base3, mid1, mid2, top) {
      return `
        <div class="math-visual">
          <div style="text-align: center;">
            <div style="margin: 8px 0; font-size: 20px; font-weight: 900; color: var(--feedback-success);">${top}</div>
            <div style="display: flex; justify-content: center; gap: 24px; margin: 8px 0;">
              <div style="font-size: 18px; font-weight: 700;">${mid1}</div>
              <div style="font-size: 18px; font-weight: 700;">${mid2}</div>
            </div>
            <div style="display: flex; justify-content: center; gap: 16px; margin: 8px 0;">
              <div style="font-size: 16px;">${base1}</div>
              <div style="font-size: 16px;">${base2}</div>
              <div style="font-size: 16px;">${base3}</div>
            </div>
          </div>
          <div class="math-steps" style="margin-top: 16px;">
            <div class="math-step">
              <div class="math-step-label">Schritt 1: Untere Ebene</div>
              ${base1} + ${base2} = ${mid1}
            </div>
            <div class="math-step">
              <div class="math-step-label">Schritt 2: Untere Ebene</div>
              ${base2} + ${base3} = ${mid2}
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Schritt 3: Spitze</div>
              ${mid1} + ${mid2} = ${top}
            </div>
          </div>
        </div>
      `;
    }
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MATHE-GENERATOREN - VERBESSERT mit visuellen Rechenwegen
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  
  const MATH = {
    _distract: {
      addSub(a, b, correct, op) {
        const d = new Set();
        d.add(correct + 1); d.add(correct - 1);
        if (op === '+') d.add(a - b); else d.add(a + b);
        if (correct > 9) d.add(parseInt(String(correct).split('').reverse().join('')));
        return [...d].filter(x => x !== correct && x > 0 && Number.isFinite(x)).slice(0, 2);
      },
      mult(a, b, correct) {
        const d = new Set();
        d.add(a * (b - 1)); d.add(a * (b + 1));
        d.add((a - 1) * b); d.add((a + 1) * b);
        d.add(a + b);
        return [...d].filter(x => x !== correct && x > 0).slice(0, 2);
      },
      div(quotient, remainder, divisor) {
        const d = new Set();
        const correct = remainder > 0 ? `${quotient} R${remainder}` : String(quotient);
        d.add(remainder > 0 ? `${quotient + 1} R${remainder}` : String(quotient + 1));
        d.add(remainder > 0 ? `${quotient} R${(remainder + 1) % divisor}` : String(quotient - 1));
        if (remainder > 0) d.add(`${quotient + 1} R0`);
        return [...d].filter(x => x !== correct).slice(0, 2);
      }
    },

    /* ‚ïê‚ïê‚ïê LEVEL 0: VORSCHULE ‚ïê‚ïê‚ïê */
    
    createCounting: () => {
      const num = r(3, 10);
      const items = ['üçé', '‚≠ê', 'üéà', 'üê±', 'üöó', 'üå∏', 'ü¶ã', 'üé®'];
      const item = pick(items);
      const distractors = [num + 1, num - 1, num + 2].filter(x => x > 0 && x !== num);
      const visual = VisualMath.countVisual(item, num);
      return {
        q: `Z√§hle die Objekte:\n\nWie viele sind es?`,
        a: num,
        options: shuffle([num, ...distractors.slice(0, 2)]),
        explain: `
          ${visual}
          <div class="math-visual">
            <div class="math-step highlight">
              <div class="math-step-label">Z√§hlen</div>
              1, 2, 3, ... bis <strong>${num}</strong>
            </div>
            <div class="math-step">
              <div class="math-step-label">Ergebnis</div>
              Es sind <strong>${num} St√ºck</strong>
            </div>
          </div>
        `,
        focus: 'Z√§hlen',
        type: 'counting'
      };
    },

    createSimpleAdd: () => {
      const a = r(1, 5);
      const b = r(1, 5);
      const sum = a + b;
      if (sum > 10) return MATH.createCounting();
      const distractors = MATH._distract.addSub(a, b, sum, '+');
      return {
        q: `${a} + ${b} = ?`,
        a: sum,
        options: shuffle([sum, ...distractors]),
        explain: `
          <div class="math-visual">
            <div class="math-step">
              <div class="math-step-label">Aufgabe</div>
              ${a} + ${b} = ?
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Rechnung untereinander</div>
              ${VisualMath.additionBox(a, b, sum)}
            </div>
            <div class="math-step">
              <div class="math-step-label">Zahlenstrahl</div>
              ${VisualMath.numberLine(0, 10, [a, sum])}
              <div style="text-align: center; margin-top: 8px; font-size: 14px;">
                Start bei ${a}, dann ${b} Schritte ‚Üí ${sum}
              </div>
            </div>
          </div>
        `,
        focus: 'Addition bis 10',
        type: 'add-simple'
      };
    },

    createSimpleSub: () => {
      const a = r(5, 10);
      const b = r(1, Math.min(4, a - 1));
      const diff = a - b;
      const distractors = MATH._distract.addSub(a, b, diff, '-');
      return {
        q: `${a} ‚àí ${b} = ?`,
        a: diff,
        options: shuffle([diff, ...distractors]),
        explain: `
          <div class="math-visual">
            <div class="math-step">
              <div class="math-step-label">Aufgabe</div>
              ${a} ‚àí ${b} = ?
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Rechnung untereinander</div>
              ${VisualMath.subtractionBox(a, b, diff)}
            </div>
            <div class="math-step">
              <div class="math-step-label">Zahlenstrahl</div>
              ${VisualMath.numberLine(0, 10, [diff, a])}
              <div style="text-align: center; margin-top: 8px; font-size: 14px;">
                Start bei ${a}, dann ${b} Schritte zur√ºck ‚Üí ${diff}
              </div>
            </div>
          </div>
        `,
        focus: 'Subtraktion bis 10',
        type: 'sub-simple'
      };
    },

    createNumberLine: () => {
      const missing = r(3, 8);
      const before = missing - 1;
      const after = missing + 1;
      return {
        q: `Welche Zahl fehlt?\n\n${before}  ?  ${after}`,
        a: missing,
        options: shuffle([missing, missing + 1, missing - 1]),
        explain: `
          <div class="math-visual">
            <div class="math-step">
              <div class="math-step-label">Zahlenreihe</div>
              ${VisualMath.numberLine(before - 1, after + 1, missing)}
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">L√∂sung</div>
              Zwischen ${before} und ${after} liegt <strong>${missing}</strong>
            </div>
          </div>
        `,
        focus: 'Zahlenreihe',
        type: 'numberline'
      };
    },

    createCompare: () => {
      const a = r(3, 9);
      const b = r(3, 9);
      if (a === b) return MATH.createCompare();
      const bigger = Math.max(a, b);
      const smaller = Math.min(a, b);
      const isGreater = Math.random() < 0.5;
      if (isGreater) {
        return {
          q: `Welche Zahl ist gr√∂√üer?\n\n${a}  oder  ${b}?`,
          a: bigger,
          options: shuffle([bigger, smaller]),
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Zahlenstrahl-Vergleich</div>
                ${VisualMath.numberLine(Math.min(a, b) - 1, Math.max(a, b) + 1, bigger)}
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Regel</div>
                Je weiter <strong>rechts</strong> auf dem Zahlenstrahl, desto <strong>gr√∂√üer</strong> die Zahl.
              </div>
              <div class="math-step">
                <div class="math-step-label">Ergebnis</div>
                ${bigger} > ${smaller} (${bigger} ist gr√∂√üer)
              </div>
            </div>
          `,
          focus: 'Vergleichen',
          type: 'compare'
        };
      } else {
        return {
          q: `Welche Zahl ist kleiner?\n\n${a}  oder  ${b}?`,
          a: smaller,
          options: shuffle([bigger, smaller]),
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Zahlenstrahl-Vergleich</div>
                ${VisualMath.numberLine(Math.min(a, b) - 1, Math.max(a, b) + 1, smaller)}
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Regel</div>
                Je weiter <strong>links</strong> auf dem Zahlenstrahl, desto <strong>kleiner</strong> die Zahl.
              </div>
              <div class="math-step">
                <div class="math-step-label">Ergebnis</div>
                ${smaller} < ${bigger} (${smaller} ist kleiner)
              </div>
            </div>
          `,
          focus: 'Vergleichen',
          type: 'compare'
        };
      }
    },

    /* ‚ïê‚ïê‚ïê LEVEL 1: KLASSE 1 ‚ïê‚ïê‚ïê */
    
    createDecomposition: () => {
      const num = r(11, 19);
      const tens = Math.floor(num / 10);
      const ones = num % 10;
      const correct = `${tens}Z + ${ones}E`;
      const distractors = [`${ones}Z + ${tens}E`, `${tens}Z + ${ones + 1}E`, `${tens}Z + ${ones - 1}E`].filter(x => x !== correct);
      return {
        q: `Zerlege die Zahl ${num}`,
        a: correct,
        options: shuffle([correct, ...distractors.slice(0, 2)]),
        explain: `
          ${VisualMath.decompositionBox(num, tens, ones)}
          <div class="math-visual" style="margin-top: 16px;">
            <div class="math-step highlight">
              <div class="math-step-label">Merke</div>
              <strong>Z</strong> = Zehner (= 10)<br>
              <strong>E</strong> = Einer (= 1)
            </div>
          </div>
        `,
        focus: 'Zahlzerlegung',
        type: 'decomposition'
      };
    },
    
    createDoubling: () => {
      const num = r(5, 10);
      const doubled = num * 2;
      const isDouble = Math.random() < 0.5;
      if (isDouble) {
        return {
          q: `Was ist das Doppelte von ${num}?`,
          a: doubled,
          options: shuffle([doubled, doubled + 1, num + 1, doubled - 1].filter((v,i,a) => a.indexOf(v) === i).slice(0, 3)),
          explain: VisualMath.doublingBox(num, doubled),
          focus: 'Verdoppeln',
          type: 'doubling'
        };
      } else {
        return {
          q: `Was ist die H√§lfte von ${doubled}?`,
          a: num,
          options: shuffle([num, num + 1, num - 1, doubled - 1].filter((v,i,a) => a.indexOf(v) === i).slice(0, 3)),
          explain: VisualMath.halvingBox(doubled, num),
          focus: 'Halbieren',
          type: 'halving'
        };
      }
    },
    
    createStory1: () => {
      const stories = [
        { ctx: "üéà Lisa hat {a} Luftballons.\nSie bekommt {b} dazu.", op: '+', items: 'Luftballons' },
        { ctx: "üçé Max hat {a} √Ñpfel.\nEr isst {b} √Ñpfel.", op: '-', items: '√Ñpfel' },
        { ctx: "üê¶ Auf dem Baum sitzen {a} V√∂gel.\n{b} fliegen weg.", op: '-', items: 'V√∂gel' },
        { ctx: "üß∏ Emma hat {a} Spielzeuge.\nSie bekommt {b} neue.", op: '+', items: 'Spielzeuge' },
        { ctx: "üç¨ Im Glas sind {a} Bonbons.\nOma legt {b} dazu.", op: '+', items: 'Bonbons' },
        { ctx: "üñçÔ∏è Tim hat {a} Stifte.\nEr verschenkt {b}.", op: '-', items: 'Stifte' }
      ];
      const story = pick(stories);
      const a = r(5, 15);
      const b = r(2, Math.min(8, a - 1));
      const result = story.op === '+' ? a + b : a - b;
      const text = story.ctx.replace('{a}', a).replace('{b}', b);
      const distractors = MATH._distract.addSub(a, b, result, story.op);
      const visual = story.op === '+' ? VisualMath.additionBox(a, b, result) : VisualMath.subtractionBox(a, b, result);
      return {
        q: `${text}\n\nWie viele ${story.items}?`,
        a: result,
        options: shuffle([result, ...distractors]),
        explain: `
          <div class="math-visual">
            <div class="math-step">
              <div class="math-step-label">Schritt 1: Zahlen herauslesen</div>
              Start: ${a} ${story.items}<br>
              ${story.op === '+' ? 'Dazu kommen' : 'Weg gehen'}: ${b} ${story.items}
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Schritt 2: Rechnung</div>
              ${visual}
            </div>
            <div class="math-step">
              <div class="math-step-label">Schritt 3: Antwort</div>
              Es sind <strong>${result} ${story.items}</strong>
            </div>
          </div>
        `,
        focus: 'Rechengeschichte',
        type: 'story'
      };
    },

    createNeighbors: () => {
      const num = r(10, 19);
      const type = pick(['vor', 'nach', 'zwischen']);
      if (type === 'vor') {
        return {
          q: `Welche Zahl kommt direkt VOR ${num}?`,
          a: num - 1,
          options: shuffle([num - 1, num + 1, num - 2]),
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Zahlenstrahl</div>
                ${VisualMath.numberLine(num - 3, num + 1, num - 1)}
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Regel: Vorg√§nger</div>
                Vorg√§nger = <strong>-1</strong><br>
                ${num} ‚àí 1 = ${num - 1}
              </div>
            </div>
          `,
          focus: 'Vorg√§nger',
          type: 'neighbor'
        };
      } else if (type === 'nach') {
        return {
          q: `Welche Zahl kommt direkt NACH ${num}?`,
          a: num + 1,
          options: shuffle([num + 1, num - 1, num + 2]),
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Zahlenstrahl</div>
                ${VisualMath.numberLine(num - 1, num + 3, num + 1)}
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Regel: Nachfolger</div>
                Nachfolger = <strong>+1</strong><br>
                ${num} + 1 = ${num + 1}
              </div>
            </div>
          `,
          focus: 'Nachfolger',
          type: 'neighbor'
        };
      } else {
        return {
          q: `Welche Zahl liegt zwischen\n${num - 1} und ${num + 1}?`,
          a: num,
          options: shuffle([num, num - 1, num + 2]),
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Zahlenstrahl</div>
                ${VisualMath.numberLine(num - 2, num + 2, num)}
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Regel: Zwischenzahl</div>
                Zwischen ${num - 1} und ${num + 1} liegt genau <strong>${num}</strong>
              </div>
            </div>
          `,
          focus: 'Zwischenzahl',
          type: 'neighbor'
        };
      }
    },

    /* ‚ïê‚ïê‚ïê LEVEL 2: KLASSE 2 ‚ïê‚ïê‚ïê */
    
    createMoney: () => {
      const items = [
        { name: 'üç´ Schoko', price: r(1, 3) },
        { name: 'ü•§ Saft', price: r(1, 2) },
        { name: 'üçé Apfel', price: 1 },
        { name: 'üç™ Keks', price: r(1, 2) },
        { name: 'üç¶ Eis', price: r(2, 3) },
        { name: 'ü•® Brezel', price: r(1, 2) }
      ];
      const item1 = pick(items);
      const item2 = pick(items.filter(i => i !== item1));
      const total = item1.price + item2.price;
      const paid = total + r(1, 3);
      const change = paid - total;
      const distractors = [`${change + 1}‚Ç¨`, `${total}‚Ç¨`, `${change - 1}‚Ç¨`, `${paid}‚Ç¨`].filter(x => x !== `${change}‚Ç¨`);
      return {
        q: `Du kaufst:\n${item1.name} (${item1.price}‚Ç¨)\n${item2.name} (${item2.price}‚Ç¨)\n\nDu zahlst ${paid}‚Ç¨.\nWie viel zur√ºck?`,
        a: `${change}‚Ç¨`,
        options: shuffle([`${change}‚Ç¨`, ...distractors.slice(0, 2)]),
        explain: `
          <div class="math-visual">
            <div class="math-step">
              <div class="math-step-label">Schritt 1: Gesamtpreis</div>
              ${VisualMath.additionBox(item1.price, item2.price, total)}
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Schritt 2: R√ºckgeld</div>
              ${VisualMath.subtractionBox(paid, total, change)}
            </div>
            <div class="math-step">
              <div class="math-step-label">Antwort</div>
              Du bekommst <strong>${change}‚Ç¨</strong> zur√ºck
            </div>
          </div>
        `,
        focus: 'Geld rechnen',
        type: 'money'
      };
    },
    
    createTime: () => {
      const hour = r(1, 11);
      const minutes = pick([0, 15, 30, 45]);
      const timeStr = minutes === 0 ? `${hour} Uhr` : minutes === 15 ? `Viertel nach ${hour}` : minutes === 30 ? `halb ${hour + 1}` : `Viertel vor ${hour + 1}`;
      const digital = `${hour}:${String(minutes).padStart(2, '0')}`;
      const wrongHour = minutes === 30 ? `${hour + 1}:30` : `${hour + 1}:${String(minutes).padStart(2, '0')}`;
      const wrongMin = `${hour}:${String((minutes + 15) % 60).padStart(2, '0')}`;
      return {
        q: `üïê Wie sp√§t ist es?\n\n"${timeStr}"`,
        a: digital,
        options: shuffle([digital, wrongHour, wrongMin]),
        explain: `
          <div class="math-visual">
            <div class="math-step">
              <div class="math-step-label">Analoge Uhrzeit</div>
              <div style="font-size: 20px; text-align: center; margin: 12px 0;">${timeStr}</div>
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Digitale Uhrzeit</div>
              <div style="font-size: 32px; text-align: center; margin: 12px 0; font-weight: 900; color: var(--col-math);">${digital}</div>
            </div>
            ${minutes === 30 ? `
            <div class="math-step">
              <div class="math-step-label">‚ö†Ô∏è H√§ufiger Fehler!</div>
              <strong>"halb ${hour + 1}"</strong> bedeutet <strong>${hour}:30</strong><br>
              (nicht ${hour + 1}:30!)
            </div>` : ''}
            <div class="math-step">
              <div class="math-step-label">Merke</div>
              Viertel nach = :15<br>
              Halb = :30<br>
              Viertel vor = :45
            </div>
          </div>
        `,
        focus: 'Uhrzeit',
        type: 'time'
      };
    },
    
    createPyramid: () => {
      const base1 = r(5, 15);
      const base2 = r(5, 15);
      const base3 = r(5, 15);
      const mid1 = base1 + base2;
      const mid2 = base2 + base3;
      const top = mid1 + mid2;
      return {
        q: `Rechenpyramide:\n\n      [?]\n    [${mid1}]  [${mid2}]\n  [${base1}]  [${base2}]  [${base3}]\n\nWas steht oben?`,
        a: top,
        options: shuffle([top, mid1 + base3, top + 1, mid2 + base1].filter((v,i,a) => a.indexOf(v) === i).slice(0, 3)),
        explain: VisualMath.pyramidBox(base1, base2, base3, mid1, mid2, top),
        focus: 'Rechenpyramide',
        type: 'pyramid'
      };
    },

    createLength: () => {
      const types = [
        { 
          q: `Wie viele cm sind 1 Meter?`, 
          a: '100 cm', 
          opts: ['100 cm', '10 cm', '1000 cm'], 
          explain: `
            <div class="math-visual">
              <div class="math-step highlight">
                <div class="math-step-label">Umrechnung</div>
                <strong>1 m = 100 cm</strong>
              </div>
              <div class="math-step">
                <div class="math-step-label">Merke</div>
                m = Meter (gro√ü)<br>
                cm = Zentimeter (klein)<br>
                1 m = 100 cm
              </div>
            </div>
          `
        },
        { 
          q: `Wie viele mm sind 1 cm?`, 
          a: '10 mm', 
          opts: ['10 mm', '100 mm', '1 mm'], 
          explain: `
            <div class="math-visual">
              <div class="math-step highlight">
                <div class="math-step-label">Umrechnung</div>
                <strong>1 cm = 10 mm</strong>
              </div>
              <div class="math-step">
                <div class="math-step-label">Merke</div>
                cm = Zentimeter<br>
                mm = Millimeter (sehr klein)<br>
                1 cm = 10 mm
              </div>
            </div>
          `
        }
      ];
      const t = pick(types);
      return { q: t.q, a: t.a, options: shuffle(t.opts), explain: t.explain, focus: 'L√§ngenma√üe', type: 'length' };
    },

    createWeight: () => {
      const types = [
        { 
          q: `Wie viele g sind 1 kg?`, 
          a: '1000 g', 
          opts: ['1000 g', '100 g', '10 g'], 
          explain: `
            <div class="math-visual">
              <div class="math-step highlight">
                <div class="math-step-label">Umrechnung</div>
                <strong>1 kg = 1000 g</strong>
              </div>
              <div class="math-step">
                <div class="math-step-label">Merke</div>
                kg = Kilogramm (schwer)<br>
                g = Gramm (leicht)<br>
                1 kg = 1000 g
              </div>
            </div>
          `
        }
      ];
      const t = pick(types);
      return { q: t.q, a: t.a, options: shuffle(t.opts), explain: t.explain, focus: 'Gewicht', type: 'weight' };
    },

    /* ‚ïê‚ïê‚ïê LEVEL 3: KLASSE 3 ‚ïê‚ïê‚ïê */
    
    createDivisionRemainder: () => {
      const divisor = r(3, 7);
      const quotient = r(5, 12);
      const remainder = r(1, divisor - 1);
      const dividend = divisor * quotient + remainder;
      const correct = `${quotient} R${remainder}`;
      const distractors = MATH._distract.div(quotient, remainder, divisor);
      return {
        q: `${dividend} : ${divisor} = ?`,
        a: correct,
        options: shuffle([correct, ...distractors]),
        explain: VisualMath.divisionBox(dividend, divisor, quotient, remainder),
        focus: 'Division mit Rest',
        type: 'div-remainder'
      };
    },

    createGeometry: () => {
      const types = [
        { 
          q: `Ein Quadrat hat 4 Seiten √† 8 cm.\nWie lang ist der Umfang?`, 
          a: '32 cm', 
          opts: ['32 cm', '16 cm', '64 cm'], 
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Quadrat</div>
                Alle 4 Seiten gleich lang: 8 cm
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Umfang</div>
                ${VisualMath.multiplicationBox(4, 8, 32)}
              </div>
              <div class="math-step">
                <div class="math-step-label">Formel</div>
                Umfang = 4 √ó Seitenl√§nge<br>
                U = 4 √ó 8 = <strong>32 cm</strong>
              </div>
            </div>
          `
        }
      ];
      const t = pick(types);
      return { q: t.q, a: t.a, options: shuffle(t.opts), explain: t.explain, focus: 'Geometrie', type: 'geometry' };
    },
    
    createRatio: () => {
      const problems = [
        { 
          story: "In einer Klasse sind 24 Kinder.\nDie H√§lfte sind M√§dchen.", 
          question: "Wie viele Jungen?", 
          answer: 12, 
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Schritt 1: H√§lfte berechnen</div>
                24 : 2 = 12 M√§dchen
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Schritt 2: Rest = Jungen</div>
                ${VisualMath.subtractionBox(24, 12, 12)}
              </div>
              <div class="math-step">
                <div class="math-step-label">Antwort</div>
                <strong>12 Jungen</strong>
              </div>
            </div>
          `,
          distractors: [24, 6] 
        }
      ];
      const p = pick(problems);
      return { q: `${p.story}\n\n${p.question}`, a: p.answer, options: shuffle([p.answer, ...p.distractors]), explain: p.explain, focus: 'Sachrechnen', type: 'ratio' };
    },

    createChain: () => {
      const a = r(10, 30);
      const b = r(5, 15);
      const c = r(3, 10);
      const types = [
        { 
          q: `${a} + ${b} ‚àí ${c} = ?`, 
          a: a + b - c, 
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Schritt 1: Addition</div>
                ${VisualMath.additionBox(a, b, a + b)}
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Schritt 2: Subtraktion</div>
                ${VisualMath.subtractionBox(a + b, c, a + b - c)}
              </div>
              <div class="math-step">
                <div class="math-step-label">üí° Tipp</div>
                Bei Kettenaufgaben immer <strong>von links nach rechts</strong> rechnen!
              </div>
            </div>
          `
        }
      ];
      const t = pick(types);
      const distractors = [t.a + 1, t.a - 1, a + b + c].filter(x => x !== t.a && x > 0);
      return { q: t.q, a: t.a, options: shuffle([t.a, ...distractors.slice(0, 2)]), explain: t.explain, focus: 'Kettenaufgabe', type: 'chain' };
    },

    /* ‚ïê‚ïê‚ïê LEVEL 4: KLASSE 4 ‚ïê‚ïê‚ïê */
    
    createRounding: () => {
      const num = r(1000, 9999);
      const roundTo = pick([10, 100, 1000]);
      const rounded = Math.round(num / roundTo) * roundTo;
      const wrongDown = Math.floor(num / roundTo) * roundTo;
      const wrongUp = Math.ceil(num / roundTo) * roundTo;
      const distractors = [wrongDown, wrongUp, rounded + roundTo, rounded - roundTo].filter(x => x !== rounded);
      return {
        q: `Runde ${num.toLocaleString('de-DE')}\nauf ${roundTo}er`,
        a: rounded.toLocaleString('de-DE'),
        options: shuffle([rounded.toLocaleString('de-DE'), ...distractors.slice(0, 2).map(x => x.toLocaleString('de-DE'))]),
        explain: `
          <div class="math-visual">
            <div class="math-step">
              <div class="math-step-label">Ausgangszahl</div>
              ${num.toLocaleString('de-DE')}
            </div>
            <div class="math-step highlight">
              <div class="math-step-label">Runden auf ${roundTo}er</div>
              <div style="font-size: 24px; font-weight: 900; text-align: center; margin: 12px 0; color: var(--feedback-success);">
                ${rounded.toLocaleString('de-DE')}
              </div>
            </div>
            <div class="math-step">
              <div class="math-step-label">üí° Regel</div>
              <strong>Ab 5 aufrunden</strong> (6, 7, 8, 9 ‚Üí auf)<br>
              <strong>Unter 5 abrunden</strong> (0, 1, 2, 3, 4 ‚Üí ab)
            </div>
          </div>
        `,
        focus: 'Runden',
        type: 'rounding'
      };
    },
    
    createFraction: () => {
      const denominator = pick([2, 3, 4, 5, 6, 8]);
      const numerator = r(1, denominator - 1);
      const fraction = `${numerator}/${denominator}`;
      const types = [
        { 
          q: `Was ist gr√∂√üer?\n${fraction} oder 1/2?`, 
          correct: numerator / denominator > 0.5 ? fraction : '1/2', 
          explain: `
            <div class="math-visual">
              <div class="math-step">
                <div class="math-step-label">Bruch-Vergleich</div>
                ${fraction} = ${(numerator / denominator * 100).toFixed(0)}%<br>
                1/2 = 50%
              </div>
              <div class="math-step highlight">
                <div class="math-step-label">Gr√∂√üer</div>
                <strong>${numerator / denominator > 0.5 ? fraction : '1/2'}</strong> ist gr√∂√üer
              </div>
            </div>
          `
        }
      ];
      const type = pick(types);
      const allOpts = [type.correct, fraction, '1/2', String(denominator - numerator), `${numerator}/${denominator + 2}`];
      return { q: type.q, a: type.correct, options: shuffle(allOpts.filter((v, i, a) => a.indexOf(v) === i).slice(0, 3)), explain: type.explain, focus: 'Br√ºche', type: 'fraction' };
    },

    createRoman: () => {
      const romans = [
        { r: 'I', n: 1 }, { r: 'II', n: 2 }, { r: 'III', n: 3 }, { r: 'IV', n: 4 }, { r: 'V', n: 5 },
        { r: 'VI', n: 6 }, { r: 'VII', n: 7 }, { r: 'VIII', n: 8 }, { r: 'IX', n: 9 }, { r: 'X', n: 10 },
        { r: 'XI', n: 11 }, { r: 'XII', n: 12 }, { r: 'XX', n: 20 }, { r: 'L', n: 50 }, { r: 'C', n: 100 }
      ];
      const item = pick(romans);
      const toArabic = Math.random() < 0.5;
      if (toArabic) {
        const distractors = [item.n + 1, item.n - 1, item.n + 5].filter(x => x > 0 && x !== item.n);
        return { 
          q: `Was bedeutet ${item.r}?`, 
          a: item.n, 
          options: shuffle([item.n, ...distractors.slice(0, 2)]), 
          explain: `
            <div class="math-visual">
              <div class="math-step highlight">
                <div class="math-step-label">Umrechnung</div>
                <div style="font-size: 32px; text-align: center; margin: 12px 0;">
                  ${item.r} = <strong>${item.n}</strong>
                </div>
              </div>
              <div class="math-step">
                <div class="math-step-label">R√∂mische Zahlen</div>
                I = 1, V = 5, X = 10, L = 50, C = 100
              </div>
            </div>
          `,
          focus: 'R√∂mische Zahlen', 
          type: 'roman' 
        };
      } else {
        const others = romans.filter(x => x.n !== item.n).map(x => x.r).slice(0, 2);
        return { 
          q: `Wie schreibt man ${item.n} r√∂misch?`, 
          a: item.r, 
          options: shuffle([item.r, ...others]), 
          explain: `
            <div class="math-visual">
              <div class="math-step highlight">
                <div class="math-step-label">Umrechnung</div>
                <div style="font-size: 32px; text-align: center; margin: 12px 0;">
                  ${item.n} = <strong>${item.r}</strong>
                </div>
              </div>
              <div class="math-step">
                <div class="math-step-label">R√∂mische Zahlen</div>
                I = 1, V = 5, X = 10, L = 50, C = 100
              </div>
            </div>
          `,
          focus: 'R√∂mische Zahlen', 
          type: 'roman' 
        };
      }
    },

    generate: (level) => {
      const generators = {
        0: [MATH.createCounting, MATH.createSimpleAdd, MATH.createSimpleSub, MATH.createNumberLine, MATH.createCompare],
        1: [MATH.createDecomposition, MATH.createDoubling, MATH.createStory1, MATH.createNeighbors],
        2: [MATH.createMoney, MATH.createTime, MATH.createPyramid, MATH.createDoubling, MATH.createLength, MATH.createWeight],
        3: [MATH.createDivisionRemainder, MATH.createGeometry, MATH.createRatio, MATH.createPyramid, MATH.createChain],
        4: [MATH.createRounding, MATH.createFraction, MATH.createRatio, MATH.createGeometry, MATH.createRoman]
      };
      
      for (let attempt = 0; attempt < 5; attempt++) {
        const gen = pick(generators[level] || generators[1]);
        const task = gen();
        if (task && task.q && task.a !== undefined && 
            Array.isArray(task.options) && task.options.length >= 2 &&
            task.options.map(String).includes(String(task.a)) &&
            new Set(task.options.map(String)).size === task.options.length) {
          return task;
        }
      }
      return MATH.createDoubling();
    }
  };

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP STATE & LOGIC
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  
  const State = {
    level: parseInt(localStorage.getItem('mathe_level') || '0'),
    coins: parseInt(localStorage.getItem('mathe_coins') || '0'),
    streak: 0,
    currentTask: null,
    
    save() {
      localStorage.setItem('mathe_level', this.level);
      localStorage.setItem('mathe_coins', this.coins);
    },
    
    addCoins(amount) {
      this.coins += amount;
      this.save();
      updateCoins();
    }
  };

  function updateCoins() {
    $('#coin-count').textContent = State.coins;
    $('.score-badge').classList.add('pulse');
    setTimeout(() => $('.score-badge').classList.remove('pulse'), 400);
  }

  function renderTask() {
    const levelNames = ['Vorschule', 'Klasse 1', 'Klasse 2', 'Klasse 3', 'Klasse 4'];
    $('#uiTitle').textContent = 'Mathe PRO';
    $('#uiMode').textContent = levelNames[State.level];
    
    State.currentTask = MATH.generate(State.level);
    const task = State.currentTask;
    const isLong = task.options.some(opt => String(opt).length > 12);
    
    const html = `
      <div class="level-selector">
        ${[0,1,2,3,4].map(l => `<button class="level-btn ${l === State.level ? 'active' : ''}" data-level="${l}">${levelNames[l]}</button>`).join('')}
      </div>
      
      <div class="streak-indicator">
        ${[0,1,2,3,4].map(i => `<div class="streak-dot ${i < State.streak ? 'filled' : ''}"></div>`).join('')}
      </div>
      
      <div class="task-card">
        <div class="task-label">${task.focus || 'AUFGABE'}</div>
        <div class="task-prompt ${task.q.length > 60 ? 'small' : ''}">${task.q}</div>
      </div>
      
      <div class="choices ${isLong ? 'single-col' : ''}">
        ${task.options.map((o, i) => `<button class="btn-answer" data-val="${o}" data-index="${i + 1}">${o}</button>`).join('')}
      </div>
      
      <details class="explain-box" id="explBox">
        <summary>üí° Rechenweg anzeigen</summary>
        <div class="explain-content">${task.explain}</div>
      </details>
    `;
    
    $('#content').innerHTML = html;
    
    $$('.level-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        State.level = parseInt(btn.dataset.level);
        State.streak = 0;
        State.save();
        renderTask();
      });
    });
    
    $$('.btn-answer').forEach(btn => {
      btn.addEventListener('click', () => checkAnswer(btn, task));
    });
    
    setupKeyboard(task.options.length);
  }

  function checkAnswer(btn, task) {
    const userAnswer = String(btn.dataset.val);
    const correctAnswer = String(task.a);
    const isCorrect = userAnswer === correctAnswer;
    
    $$('.btn-answer').forEach(b => b.disabled = true);
    
    if (isCorrect) {
      btn.classList.add('correct');
      State.streak++;
      const coins = State.streak >= 5 ? 3 : 1;
      State.addCoins(coins);
      
      if (State.streak >= 5) {
        State.streak = 0;
      }
    } else {
      btn.classList.add('wrong');
      State.streak = 0;
      const correctBtn = $$('.btn-answer').find(b => String(b.dataset.val) === correctAnswer);
      setTimeout(() => {
        if (correctBtn) correctBtn.classList.add('correct');
      }, 300);
    }
    
    setTimeout(() => {
      $('#explBox').setAttribute('open', '');
      $('#explBox').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 600);
    
    $('#btnNext').disabled = false;
  }

  function setupKeyboard(optionCount) {
    const handler = (e) => {
      const key = e.key;
      if (key >= '1' && key <= String(optionCount)) {
        const index = parseInt(key) - 1;
        const btn = $$('.btn-answer')[index];
        if (btn && !btn.disabled) btn.click();
      } else if (key === 'h' || key === 'H') {
        $('#explBox').toggleAttribute('open');
      }
    };
    
    document.removeEventListener('keydown', window._keyHandler);
    document.addEventListener('keydown', handler);
    window._keyHandler = handler;
  }

  $('#btnBack').addEventListener('click', () => {
    window.location.href = '../index.html';
  });
  
  $('#btnNext').addEventListener('click', () => {
    $('#btnNext').disabled = true;
    renderTask();
  });
  
  updateCoins();
  renderTask();
  
  console.log('‚úÖ Mathe PRO geladen!');
  console.log('üé® Visuelle Rechenwege aktiv');
  console.log('üìê Phase 1-3 Design-System');
})();
</script>
</body>
</html>
